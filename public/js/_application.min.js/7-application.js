var apiEndpoint = 'http://book.hyko.org/api';

window.App = {};
window.App.online = true;


App.Section = Backbone.Model.extend({
  initialize: function() {
  },

  url : function() {
    return apiEndpoint + "/get_page/?post_type=chapters&id="+ this.id + "&children=true"
  },
  parse: function(response) {
    return response.page;
  }
});

App.Sections = Backbone.Collection.extend({
  model: App.Section
});

App.Chapter = Backbone.Model.extend({
});

App.Chapters = Backbone.Collection.extend({
  model: App.Chapter
});

App.SubChapter = Backbone.Model.extend({
  initialize: function(o) {
    this.id = o.id;
    this.comments = new App.Comments(o.comments);
  }
});

App.SubChapters = Backbone.Collection.extend({
  model: App.SubChapter
});

App.Comment = Backbone.Model.extend({
  sync: function(method, model, options) {
    if (method === "create") {
     $.ajax({
       type: 'POST',
       url: apiEndpoint + '/submit_comment/?post_id=' + model.get('post_id'),
       data: model.toJSON(),
       complete: function(xhr, status) {
         var response = JSON.parse(xhr.responseText);
         if (response.status === "error") {
           alert(response.error)
         }
       },
       error: function(xhr, status) {
         console.log(xhr)
         // alert()
       }
     })
    }
  }
});

App.Comments = Backbone.Collection.extend({
    model: App.Comment,
    localStorage: new Store("app-comments")
});


// Sections List View
// ==================

App.SectionsView = Backbone.View.extend({
  __name__: "Section List View",
  tagName : 'ol',
  className : 'section-list',
  render : function() {
    this.collection.each(function(d) {
      var sectionView = new App.SectionView({ model : d });
      $(this.el).append(sectionView.render().el);
    }, this);
    return this;
  }
});


// Section View
// ============

App.SectionView = Backbone.View.extend({
  __name__: "Section View",
  tagName: 'li',
  className: 'section',
  render: function() {
    var that = this;
    var template =  _.template($("#template-section").html());
    var html = template(this.model.toJSON());
    $(this.el).append(html);

    this.model.fetch({success: function(model, response){
      // Init the Chapters
      that.chapters = new App.Chapters(model.attributes.children)
      that.chaptersView = new App.ChaptersView({ collection : that.chapters });
      $(that.el).find('.dive-wrapper').html(that.chaptersView.render().el);
    }});

    return this;
  }
});


// Chapter List View
// =================

App.ChaptersView = Backbone.View.extend({
  __name__: "Chapter List View",
  tagName : 'ol',
  className : 'chapter-list',
  render: function() {
    this.collection.each(function(d) {
      var chapterView = new App.ChapterView({ model: d });
      $(this.el).append(chapterView.render().el);
    }, this);
    return this;
  }
});

// Chapter View
// ============

App.ChapterView = Backbone.View.extend({
  __name__: "Chapter View",
  tagName: "li",
  className: "chapter",
  render : function() {
    var that = this;

    var template =  _.template($("#template-chapter").html());
    var html = template(this.model.toJSON());
    $(this.el).append(html); // Temp hide

    that.subChapters = new App.SubChapters(this.model.attributes.children)
    that.subChaptersView = new App.SubChaptersView({ collection : that.subChapters });
    $(that.el).find('.dive-wrapper').html(that.subChaptersView.render().el);

    return this;
  }
})


// SubChapter List View
// ====================

App.SubChaptersView = Backbone.View.extend({
  __name__: "SubChapter List View",
  tagName : 'ol',
  className : 'subchapter-list',

  render: function() {
    this.collection.each(function(d) {
      var subChapterView = new App.SubChapterView({ model : d });
      $(this.el).append(subChapterView.render());
    }, this);
    return this;
  }
});


// SubChapter View
// ===============

App.SubChapterView = Backbone.View.extend({
  __name__: "SubChapter View",
  tagName : 'li',
  className : 'subchapter',

  initialize: function() {
    this.model.comments.bind('add', this.addOne, this);
  },

  render: function() {
    var that = this;
    // Comments template
    if (that.model.get('comment_status') === 'open') {
      var commentsView = new App.CommentsView({
        collection: that.model.comments,
        model: that.model,
        tagName: 'div',
        className: 'target target--comments'
      });
      $(this.el).append(commentsView.render().el);
    }
    return $(this.el).append(this.model.toJSON().content);
    //return  this.el; // this.model.toJSON().content;
  },

  addOne: function(comment) {
    var commentView = new App.CommentView({
      model : comment
    });
    $(this.el).find('.comment-list').append(commentView.render().el);
  }
});


// Comments List View + Form
// =========================

App.CommentsView = Backbone.View.extend({
  __name__: "Comment List and Form View",
  // tagName : "ol",
  // className : "comment-list" // This doesnâ€™t seem to create an element, list is appended to ul.comment-list template
  events: {

    "click": "preventDefault",
    // "click .target--comments": "toggleComments",
    // "tap .target--comments": "toggleComments",
    // "openPanel .target--comments" : "toggleComments",
    // "clsePanel .target--comments" : "toggleComments",

    "click .add" : "showCommentForm",
    "click .cancel" : "cancelCommentForm",
    "click .comment-form .submit": "addComment"
  },

  initialize: function() {
    this.model.bind('change', this.updateCount, this);
  },

  preventDefault: function(e) {
    e.preventDefault();
    e.stopPropagation();
  },

  // This is the add button on the comments for the form
  showCommentForm : function(e) {
    e.preventDefault();
    e.stopPropagation();

    if (!$(this.el).find('.comment-add').is(":visible")) {
      var template =  _.template($("#template-comment-form").html());
      var html = template();
      $(this.el).append(html);
    }
  },

  clearForm: function() {
    $(this.el).find('.comment-form-name').val('');
    $(this.el).find('.comment-form-email').val('');
    $(this.el).find('.comment-form-content').val('');
  },

  closeForm: function() {
    $(this.el).find('.dive').toggleClass("dive--open");
    var that = this;
    window.setTimeout(function(){
      $(that.el).find('.comment-add').remove();
    },1000);

  },

  addComment: function(e) {
    e.preventDefault();
    e.stopPropagation();

    var attr = {}
    attr.data = new Date();
    attr.name = $(this.el).find('.comment-form-name').val();
    attr.email = $(this.el).find('.comment-form-email').val();
    attr.content = $(this.el).find('.comment-form-content').val();
    attr.post_id = this.model.get('id');

    this.collection.create(attr);
    this.clearForm();
    this.closeForm();

    // Update the comment count
    this.model.set('comment_count', this.model.get('comment_count') + 1);
  },

  cancelCommentForm: function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.closeForm();
  },

  toggleComments : function(e) {
    e.preventDefault();
    e.stopPropagation();
    $(this.el).find('.dive').first().toggleClass('dive--open');
  },

  // Called on 'change'
  updateCount: function() {
    $(this.el).find('.dive-count').html(this.model.get('comment_count'));
  },

  render : function() {

    var template =  _.template($("#template-comments").html());
    var html = template(this.model.toJSON());
    $(this.el).append(html);

    if (this.model.get('comment_count') === 0) {
      $(this.el).find('.view-all').addClass("hidden");
    }

    this.collection.each(function(comment) {

      var commentView = new App.CommentView({ model : comment });
      $(this.el).find('.comment-list').prepend(commentView.render().el);
    }, this);

    return this;
  }
});


// Comment View
// ============

App.CommentView = Backbone.View.extend({
  __name__: "Comment View",
  tagName: "li",
  className: "comment",

  events: {
    "click": "preventDefault",
    "tap .reply"     : "addComment",
    "click .reply"   : "addComment"
  },

  preventDefault: function(e) {
    e.preventDefault();
    e.stopPropagation();
  },

  // This is the reply button
  addComment: function(e) {
    e.preventDefault();
    e.stopPropagation();
    alert("Add Reply");
  },

  render: function() {
    var template =  _.template($("#template-comment").html());
    var html = template(this.model.toJSON());

    $(this.el).append(html);
    return this;
  }

});

App.Router = Backbone.Router.extend({
  routes: {
    '*path': 'defaultRoute'
  },

  defaultRoute: function(path) {

    var callback = function(sections) {
      App.sections = new App.Sections(sections)
      App.sectionView = new App.SectionsView({ collection: App.sections });

      $('#book').html(App.sectionView.render().el);
    }

    if (window.App.online) {
      $.getJSON(apiEndpoint + '/get_category_posts/?post_type=chapters&slug=section&order=ASC', function(sectionData, status, xhr){
        callback(sectionData.posts);
      });
    } else {
      console.log("offline")
    }
  }
});

$(function() {
  Backbone.emulateJSON = true;

  // Initialize the Backbone router.
  App.router = new App.Router();
  Backbone.history.start();

});