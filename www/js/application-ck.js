// Main Entry point into app.
window.App={};App.Decade=Backbone.Model.extend({title:"",decade:null,initialize:function(e){this.set("decade",parseInt(e.slug))}});App.Year=Backbone.Model.extend({title:"",year:null,initialize:function(e){var t=e.slug.match(/(\d{4})-(\d{2})-(\d{2})/);if(t){this.set("decade",parseInt(t[1]));this.set("year",parseInt(t[2]));this.set("part",parseInt(t[3]))}}});App.Chapter=Backbone.Model.extend({slug:"",title:"",content:"",comment_status:!1,decade:null,initialize:function(e){var t=e.slug.match(/(\d{4})-(\d{2})-(\d{2})/);if(t){this.set("decade",parseInt(t[1]));this.set("year",parseInt(t[2]));this.set("part",parseInt(t[3]))}this.comments=new App.Comments(e.comments)}});App.Comment=Backbone.Model.extend({});App.Years=Backbone.Collection.extend({model:App.Year,initialize:function(e){},comparator:function(e){return e.get("year")},parse:function(e){return e.posts}});App.Decades=Backbone.Collection.extend({model:App.Decade,url:"http://book.hyko.org/api/get_tag_posts/?tag=decade",initialize:function(){},comparator:function(e){return e.get("decade")},parse:function(e){return e.posts}});App.Chapters=Backbone.Collection.extend({model:App.Chapter,comparator:function(e,t){if(e.decade<t.decade)return 1;if(e.decade>t.decade)return-1;if(e.decade===t.decade){if(e.month<t.month)return 1;if(e.year>t.year)return-1;if(e.year===t.year){if(e.part<t.part)return 1;if(e.part>t.part)return-1;if(e.part===t.part)return 0}}},parse:function(e){return e.posts}});App.Comments=Backbone.Collection.extend({model:App.Comment,localStorage:new Store("app-comments")});App.CommentView=Backbone.View.extend({tagName:"li",className:"com_comments_comment",events:{click:"preventDefault","tap .com_comments_comment_reply":"addComment","click .com_comments_comment_reply":"addComment"},preventDefault:function(e){e.preventDefault();e.stopPropagation()},addComment:function(e){e.preventDefault();e.stopPropagation();alert("Add Reply")},render:function(){var e=_.template($("#template-comment").html()),t=e(this.model.toJSON());$(this.el).append(t);return this}});App.CommentsView=Backbone.View.extend({events:{click:"preventDefault","click .target__com":"toggleComments","tap .target__com":"toggleComments","click .button.com_comments_meta_add":"showCommentForm","click .cancel":"cancelCommentForm","click .com_add_form .submit":"addComment"},initialize:function(){this.model.bind("change",this.updateCount,this)},preventDefault:function(e){e.preventDefault();e.stopPropagation()},showCommentForm:function(e){e.preventDefault();e.stopPropagation();var t=_.template($("#template-comment-form").html()),n=t();$(this.el).append(n)},clearForm:function(){$(this.el).find(".com_add_form #commentName").val("");$(this.el).find(".com_add_form #commentEmail").val("");$(this.el).find(".com_add_form #commentText").val("")},closeForm:function(){$(this.el).find(".com_add_sec").remove()},addComment:function(e){e.preventDefault();e.stopPropagation();var t={};t.data=new Date;t.name=$(this.el).find(".com_add_form #commentName").val();t.email=$(this.el).find(".com_add_form #commentEmail").val();t.content=$(this.el).find(".com_add_form #commentText").val();this.collection.create(t);this.clearForm();this.closeForm();this.model.set("comment_count",this.model.get("comment_count")+1)},cancelCommentForm:function(e){e.preventDefault();e.stopPropagation();this.closeForm()},toggleComments:function(e){e.preventDefault();e.stopPropagation();$(this.el).find(".dive").toggleClass("dive__open")},updateCount:function(){$(this.el).find(".com_count").html(this.model.get("comment_count"))},render:function(){var e=_.template($("#template-comments").html()),t=e(this.model.toJSON());$(this.el).append(t);this.model.get("comment_count")===0&&$(this.el).find(".com_comments_actions_item .view_all").hide();this.collection.each(function(e){var t=new App.CommentView({model:e});$(this.el).find(".com_comments").append(t.render().el)},this);return this}});App.SectionView=Backbone.View.extend({tagName:"ul",initialize:function(){this.model.comments.bind("add",this.addOne,this)},render:function(){var e=_.template($("#template-section").html()),t=e(this.model.toJSON());$(this.el).append(t);if(this.model.get("comment_status")==="open"){var n=new App.CommentsView({collection:this.model.comments,model:this.model});$(this.el).append(n.render().el)}return this},addOne:function(e){var t=new App.CommentView({model:e});$(this.el).find(".com_comments").append(t.render().el);console.log(e.toJSON())}});App.DecadeView=Backbone.View.extend({tagName:"li",className:"toc_item",events:{"click .toc_item":"expandItem","tap .toc_item":"expandItem"},initialize:function(){var e=this;this.years=new App.Years(chapters);var t=function(t){if(t.attributes.year)return t.attributes.decade==e.model.get("decade")?!0:!1},n=e.years.filter(t);this.years.reset(n);var n=this.years.min(function(e){return e.attributes.part});this.years.reset(n);$(this.el).bind("openPanel",function(){$(e.el).find(".yearTOC").addClass("dive__open")},this);$(this.el).bind("closePanel",function(){$(e.el).find(".yearTOC").removeClass("dive__open")},this)},expandItem:function(e){e.preventDefault();e.stopPropagation();$(this.el).find(".dive").toggleClass("dive__open")},render:function(){var e=_.template($("#template-decade").html()),t=e(this.model.toJSON());$(this.el).append(t);this.yearsView=new App.YearsView({collection:this.years});$(this.el).find(".years").html(this.yearsView.render().el);$(this.el).find(".target__chap").html(this.yearsView.render().el);return this}});App.DecadesView=Backbone.View.extend({tagName:"ol",className:"decade",render:function(){this.collection.each(function(e){var t=new App.DecadeView({model:e});$(this.el).append(t.render().el)},this);return this}});App.ChaptersView=Backbone.View.extend({tagName:"article",className:"chap dive dive__open",render:function(){this.collection.each(function(e){var t=new App.SectionView({model:e});$(this.el).prepend(t.render().el)},this);return this}});App.YearsView=Backbone.View.extend({tagName:"ul",className:"yearTOC dive",render:function(){this.collection.each(function(e){var t=new App.YearView({model:e});$(this.el).prepend(t.render().el)},this);return this}});App.DecadeIntroView=Backbone.View.extend({initialize:function(){this.el=$("#decadeIntro");this.template=_.template($("#template-decades-header").html())},render:function(){this.el.html(this.template(this.model.toJSON()));return this}});App.YearView=Backbone.View.extend({tagName:"li",className:"yearItem",events:{click:"preventDefault","click .com_year_wrap":"launch"},initialize:function(e){var t=this;this.chapters=new App.Chapters(chapters);var n=function(e){return e.attributes.decade==t.model.get("decade")?!0:!1},r=t.chapters.filter(n);this.chapters.reset(r)},launch:function(e){document.location="#year/"+this.model.id},preventDefault:function(e){e.preventDefault();e.stopPropagation()},render:function(){var e=_.template($("#template-year").html()),t=e(this.model.toJSON());$(this.el).append(t);return this}});App.Router=Backbone.Router.extend({routes:{"year/:id":"showYear","*path":"defaultRoute"},showYear:function(e){$("#chapters").show();$("#decades").hide();$("#decadeIntro").hide();var t=new App.Chapters(chapters),n=t.filter(function(t){return t.attributes.id==e?!0:!1}),r=n[0].get("year"),i=n[0].get("decade"),s=new App.Chapters(chapters),o=s.filter(function(e){return e.attributes.year==r&&e.attributes.decade==i?!0:!1});s.reset(o);var u=new App.ChaptersView({collection:s});$("#chapters").html(u.render().el)},defaultRoute:function(e){$("#decades").show();$("#decadeIntro").show();$("#chapters").hide();var t=_.reject(_.map(decadeData,function(e){if(_.any(e.tags,function(e){return e.title=="intro"}))return e}),function(e){return e==undefined})[0],n=_.reject(decadeData,function(e){return e.id==t.id}),r=new App.Decade(t),i=new App.DecadeIntroView({model:r});i.render();App.decades=new App.Decades(n);App.decadesView=new App.DecadesView({collection:App.decades});$("#decades").html(App.decadesView.render().el)}});$(function(){Backbone.emulateJSON=!0;App.router=new App.Router;Backbone.history.start()});